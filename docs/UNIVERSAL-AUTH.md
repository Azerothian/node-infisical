# Universal Auth

## Overview

Universal Auth is the simplest identity authentication method in Infisical. It uses a client ID and client secret pair generated by Infisical itself — no external identity provider is required. This makes it ideal for server-to-server communication, CI/CD pipelines, and environments where you control both ends.

## Prerequisites

- An Infisical account with an organization
- The Infisical Node.js SDK installed: `npm install node-infisical`
- A machine identity created in Infisical (or created programmatically via the SDK)

## Provider Setup

No external provider setup is needed. Universal Auth credentials are generated and managed entirely within Infisical.

## Infisical Configuration via SDK

### Install the SDK

```bash
npm install node-infisical
```

### Create a Machine Identity

```typescript
import { InfisicalClient } from "node-infisical";

const client = new InfisicalClient({
  baseUrl: "https://app.infisical.com", // or your self-hosted URL
});

// You must already be authenticated (e.g., via a service token or another identity)
const { identity } = await client.identities.create({
  organizationId: "org_id_here",
  name: "my-service-identity",
  role: "member", // optional
  metadata: { environment: "production" } // optional
});
```

### Attach Universal Auth Method

```typescript
const { identityUniversalAuth } = await client.identityAuth.universal.attach({
  identityId: identity.id,
  clientSecretTrustedIps: [{ ipAddress: "0.0.0.0/0" }], // optional
  accessTokenTTL: 2592000, // optional, seconds (default: 30 days)
  accessTokenMaxTTL: 2592000, // optional, seconds
  accessTokenNumUsesLimit: 0, // optional, 0 = unlimited
  accessTokenTrustedIps: [{ ipAddress: "0.0.0.0/0" }], // optional
});
```

#### Attach Parameters

| Parameter | Type | Required | Description |
|-----------|------|----------|-------------|
| `identityId` | `string` | Yes | The ID of the identity to attach Universal Auth to |
| `clientSecretTrustedIps` | `Array<{ ipAddress: string }>` | No | IP addresses allowed to use client secrets. Default: `0.0.0.0/0` (any) |
| `accessTokenTTL` | `number` | No | Access token time-to-live in seconds |
| `accessTokenMaxTTL` | `number` | No | Maximum access token lifetime in seconds |
| `accessTokenNumUsesLimit` | `number` | No | Maximum number of times the access token can be used. `0` = unlimited |
| `accessTokenTrustedIps` | `Array<{ ipAddress: string }>` | No | IP addresses allowed to use the access token. Default: `0.0.0.0/0` (any) |

### Create Client Secret

```typescript
const { clientSecret, clientSecretData } = await client.identityAuth.universal.createClientSecret({
  identityId: identity.id,
  description: "Production secret", // optional
  numUsesLimit: 0, // optional, 0 = unlimited
  ttl: 0, // optional, 0 = never expires
});

// Save these — clientSecret is only shown once
console.log("Client ID:", identityUniversalAuth.clientId);
console.log("Client Secret:", clientSecret);
```

#### Create Client Secret Parameters

| Parameter | Type | Required | Description |
|-----------|------|----------|-------------|
| `identityId` | `string` | Yes | The ID of the identity |
| `description` | `string` | No | Description of the client secret |
| `numUsesLimit` | `number` | No | Max uses for this secret. `0` = unlimited |
| `ttl` | `number` | No | Time-to-live in seconds. `0` = never expires |

### Update Universal Auth

```typescript
const { identityUniversalAuth } = await client.identityAuth.universal.update({
  identityId: "identity_id_here",
  accessTokenTTL: 3600,
  accessTokenMaxTTL: 7200,
});
```

#### Update Parameters

Same as Attach parameters — all fields except `identityId` are optional.

### Get Universal Auth

```typescript
const { identityUniversalAuth } = await client.identityAuth.universal.get({
  identityId: "identity_id_here",
});
```

### Revoke Universal Auth

```typescript
const { identityUniversalAuth } = await client.identityAuth.universal.revoke({
  identityId: "identity_id_here",
});
```

### Client Secret Management

#### List Client Secrets

```typescript
const { clientSecretData } = await client.identityAuth.universal.listClientSecrets({
  identityId: "identity_id_here",
});
```

#### Get Client Secret

```typescript
const { clientSecretData } = await client.identityAuth.universal.getClientSecret({
  identityId: "identity_id_here",
  clientSecretId: "secret_id_here",
});
```

#### Revoke Client Secret

```typescript
const { clientSecretData } = await client.identityAuth.universal.revokeClientSecret({
  identityId: "identity_id_here",
  clientSecretId: "secret_id_here",
});
```

## Authenticate

Use `client.login()` with the `universalAuth` key:

```typescript
import { InfisicalClient } from "node-infisical";

const client = new InfisicalClient({
  baseUrl: "https://app.infisical.com",
});

await client.login({
  universalAuth: {
    clientId: "your_client_id",
    clientSecret: "your_client_secret",
  },
});
```

### Login Parameters

| Parameter | Type | Required | Description |
|-----------|------|----------|-------------|
| `clientId` | `string` | Yes | The client ID from the Universal Auth configuration |
| `clientSecret` | `string` | Yes | A valid client secret for this identity |

### Login Response

| Field | Type | Description |
|-------|------|-------------|
| `accessToken` | `string` | The access token for authenticating API requests |
| `expiresIn` | `number` | Token lifetime in seconds |
| `accessTokenMaxTTL` | `number` | Maximum token lifetime in seconds |
| `tokenType` | `string` | Token type (e.g., `"Bearer"`) |

## Full Working Example

```typescript
import { InfisicalClient } from "node-infisical";

async function main() {
  const client = new InfisicalClient({
    baseUrl: "https://app.infisical.com",
  });

  // Authenticate with Universal Auth
  await client.login({
    universalAuth: {
      clientId: process.env.INFISICAL_CLIENT_ID!,
      clientSecret: process.env.INFISICAL_CLIENT_SECRET!,
    },
  });

  // Now use the authenticated client to fetch secrets
  const secrets = await client.secrets.list({
    projectId: "your_project_id",
    environment: "production",
    secretPath: "/",
  });

  for (const secret of secrets.secrets) {
    console.log(`${secret.secretKey}=${secret.secretValue}`);
  }
}

main().catch(console.error);
```

## Troubleshooting

| Issue | Cause | Solution |
|-------|-------|----------|
| `401 Unauthorized` | Invalid client ID or secret | Verify credentials. Client secrets are shown only once at creation |
| `403 Forbidden` on login | IP not in trusted list | Check `clientSecretTrustedIps` on the auth config |
| `403 Forbidden` on API call | Token IP not trusted | Check `accessTokenTrustedIps` on the auth config |
| Token expires too quickly | Low `accessTokenTTL` | Update the auth config with a higher TTL value |
| Client secret not working | Secret revoked or expired | Create a new client secret; check `numUsesLimit` and `ttl` |
